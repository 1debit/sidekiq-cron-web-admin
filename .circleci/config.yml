version: 2.1

orbs:
  cit: chime/ci-tools@1

defaults: &defaults
  docker:
    - image: circleci/ruby:2-node

jobs:
  test:
    <<: *defaults
    steps:
      - cit/bundler-preamble
      - run: bundle exec rake test
  tag:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: "Tag"
          command: |
            VERSION=$(cat lib/sidekiq/cron/web/admin/version.rb | grep VERSION | sed "s/.*'\(.*\)'.*/\1/")
            if [ $(git tag -l "v$VERSION") ]; then echo "Pre existing Tag v$VERSION"; exit 1; fi

            git config --global user.email "chime@users.noreply.github.com"
            git config --global user.name "Chime Bot"
            git tag -a v$VERSION -m "v$VERSION"
            git push https://${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git v$VERSION

workflows:
  version: 2
  build_test_publish:
    jobs:
      - test
      - tag:
          context: ruby-build
          requires:
            - test
          filters:
            branches:
              only:
                - master
